#include <stddef.h>                     // Defines NULL
#include <stdbool.h>                    // Defines true
#include <stdlib.h>                     // Defines EXIT_FAILURE
#include "definitions.h"                // SYS function prototypes

#include "config/default/peripheral/tmr1/plib_tmr1.h"
#include "config/default/peripheral/gpio/plib_gpio.h"

//------------------------------------------------------------------------------

const uint8_t symbol[][8] = {
{
  0b00000000,
  0b00111100,
  0b01100110,
  0b01100110,
  0b01111110,
  0b01100110,
  0b01100110,
  0b01100110
},{
  0b00000000,
  0b01111100,
  0b01100110,
  0b01100110,
  0b01111100,
  0b01100110,
  0b01100110,
  0b01111100
},{
  0b00000000,
  0b00111100,
  0b01100110,
  0b01100000,
  0b01100000,
  0b01100000,
  0b01100110,
  0b00111100
},{
  0b00000000,
  0b01111100,
  0b01100110,
  0b01100110,
  0b01100110,
  0b01100110,
  0b01100110,
  0b01111100
},{
  0b00000000,
  0b01111110,
  0b01100000,
  0b01100000,
  0b01111100,
  0b01100000,
  0b01100000,
  0b01111110
},{
  0b00000000,
  0b01111110,
  0b01100000,
  0b01100000,
  0b01111100,
  0b01100000,
  0b01100000,
  0b01100000
},{
  0b00000000,
  0b00111100,
  0b01100110,
  0b01100000,
  0b01100000,
  0b01101110,
  0b01100110,
  0b00111100
},{
  0b00000000,
  0b01100110,
  0b01100110,
  0b01100110,
  0b01111110,
  0b01100110,
  0b01100110,
  0b01100110
},{
  0b00000000,
  0b00111100,
  0b00011000,
  0b00011000,
  0b00011000,
  0b00011000,
  0b00011000,
  0b00111100
},{
  0b00000000,
  0b00011110,
  0b00001100,
  0b00001100,
  0b00001100,
  0b01101100,
  0b01101100,
  0b00111000
},{
  0b00000000,
  0b01100110,
  0b01101100,
  0b01111000,
  0b01110000,
  0b01111000,
  0b01101100,
  0b01100110
},{
  0b00000000,
  0b01100000,
  0b01100000,
  0b01100000,
  0b01100000,
  0b01100000,
  0b01100000,
  0b01111110
},{
  0b00000000,
  0b01100011,
  0b01110111,
  0b01111111,
  0b01101011,
  0b01100011,
  0b01100011,
  0b01100011
},{
  0b00000000,
  0b01100011,
  0b01110011,
  0b01111011,
  0b01101111,
  0b01100111,
  0b01100011,
  0b01100011
},{
  0b00000000,
  0b00111100,
  0b01100110,
  0b01100110,
  0b01100110,
  0b01100110,
  0b01100110,
  0b00111100
},{
  0b00000000,
  0b01111100,
  0b01100110,
  0b01100110,
  0b01100110,
  0b01111100,
  0b01100000,
  0b01100000
},{
  0b00000000,
  0b00111100,
  0b01100110,
  0b01100110,
  0b01100110,
  0b01101110,
  0b00111100,
  0b00000110
},{
  0b00000000,
  0b01111100,
  0b01100110,
  0b01100110,
  0b01111100,
  0b01111000,
  0b01101100,
  0b01100110
},{
  0b00000000,
  0b00111100,
  0b01100110,
  0b01100000,
  0b00111100,
  0b00000110,
  0b01100110,
  0b00111100
},{
  0b00000000,
  0b01111110,
  0b01011010,
  0b00011000,
  0b00011000,
  0b00011000,
  0b00011000,
  0b00011000
},{
  0b00000000,
  0b01100110,
  0b01100110,
  0b01100110,
  0b01100110,
  0b01100110,
  0b01100110,
  0b00111110
},{
  0b00000000,
  0b01100110,
  0b01100110,
  0b01100110,
  0b01100110,
  0b01100110,
  0b00111100,
  0b00011000
},{
  0b00000000,
  0b01100011,
  0b01100011,
  0b01100011,
  0b01101011,
  0b01111111,
  0b01110111,
  0b01100011
},{
  0b00000000,
  0b01100011,
  0b01100011,
  0b00110110,
  0b00011100,
  0b00110110,
  0b01100011,
  0b01100011
},{
  0b00000000,
  0b01100110,
  0b01100110,
  0b01100110,
  0b00111100,
  0b00011000,
  0b00011000,
  0b00011000
},{
  0b00000000,
  0b01111110,
  0b00000110,
  0b00001100,
  0b00011000,
  0b00110000,
  0b01100000,
  0b01111110
},{
  0b00000000,
  0b00000000,
  0b00000000,
  0b00000000,
  0b00000000,
  0b00000000,
  0b00000000,
  0b00000000
},{
  0b00000000,
  0b00000000,
  0b00000000,
  0b00111100,
  0b00000110,
  0b00111110,
  0b01100110,
  0b00111110
},{
  0b00000000,
  0b01100000,
  0b01100000,
  0b01100000,
  0b01111100,
  0b01100110,
  0b01100110,
  0b01111100
},{
  0b00000000,
  0b00000000,
  0b00000000,
  0b00111100,
  0b01100110,
  0b01100000,
  0b01100110,
  0b00111100
},{
  0b00000000,
  0b00000110,
  0b00000110,
  0b00000110,
  0b00111110,
  0b01100110,
  0b01100110,
  0b00111110
},{
  0b00000000,
  0b00000000,
  0b00000000,
  0b00111100,
  0b01100110,
  0b01111110,
  0b01100000,
  0b00111100
},{
  0b00000000,
  0b00011100,
  0b00110110,
  0b00110000,
  0b00110000,
  0b01111100,
  0b00110000,
  0b00110000
},{
  0b00000000,
  0b00000000,
  0b00111110,
  0b01100110,
  0b01100110,
  0b00111110,
  0b00000110,
  0b00111100
},{
  0b00000000,
  0b01100000,
  0b01100000,
  0b01100000,
  0b01111100,
  0b01100110,
  0b01100110,
  0b01100110
},{
  0b00000000,
  0b00000000,
  0b00011000,
  0b00000000,
  0b00011000,
  0b00011000,
  0b00011000,
  0b00111100
},{
  0b00000000,
  0b00001100,
  0b00000000,
  0b00001100,
  0b00001100,
  0b01101100,
  0b01101100,
  0b00111000
},{
  0b00000000,
  0b01100000,
  0b01100000,
  0b01100110,
  0b01101100,
  0b01111000,
  0b01101100,
  0b01100110
},{
  0b00000000,
  0b00011000,
  0b00011000,
  0b00011000,
  0b00011000,
  0b00011000,
  0b00011000,
  0b00011000
},{
  0b00000000,
  0b00000000,
  0b00000000,
  0b01100011,
  0b01110111,
  0b01111111,
  0b01101011,
  0b01101011
},{
  0b00000000,
  0b00000000,
  0b00000000,
  0b01111100,
  0b01111110,
  0b01100110,
  0b01100110,
  0b01100110
},{
  0b00000000,
  0b00000000,
  0b00000000,
  0b00111100,
  0b01100110,
  0b01100110,
  0b01100110,
  0b00111100
},{
  0b00000000,
  0b00000000,
  0b01111100,
  0b01100110,
  0b01100110,
  0b01111100,
  0b01100000,
  0b01100000
},{
  0b00000000,
  0b00000000,
  0b00111100,
  0b01101100,
  0b01101100,
  0b00111100,
  0b00001101,
  0b00001111
},{
  0b00000000,
  0b00000000,
  0b00000000,
  0b01111100,
  0b01100110,
  0b01100110,
  0b01100000,
  0b01100000
},{
  0b00000000,
  0b00000000,
  0b00000000,
  0b00111110,
  0b01000000,
  0b00111100,
  0b00000010,
  0b01111100
},{
  0b00000000,
  0b00000000,
  0b00011000,
  0b00011000,
  0b01111110,
  0b00011000,
  0b00011000,
  0b00011000
},{
  0b00000000,
  0b00000000,
  0b00000000,
  0b01100110,
  0b01100110,
  0b01100110,
  0b01100110,
  0b00111110
},{
  0b00000000,
  0b00000000,
  0b00000000,
  0b00000000,
  0b01100110,
  0b01100110,
  0b00111100,
  0b00011000
},{
  0b00000000,
  0b00000000,
  0b00000000,
  0b01100011,
  0b01101011,
  0b01101011,
  0b01101011,
  0b00111110
},{
  0b00000000,
  0b00000000,
  0b00000000,
  0b01100110,
  0b00111100,
  0b00011000,
  0b00111100,
  0b01100110
},{
  0b00000000,
  0b00000000,
  0b00000000,
  0b01100110,
  0b01100110,
  0b00111110,
  0b00000110,
  0b00111100
},{
  0b00000000,
  0b00000000,
  0b00000000,
  0b00111100,
  0b00001100,
  0b00011000,
  0b00110000,
  0b00111100
}};


#define DECODE_MODE_REG     0x09
#define DISABLE_DECODE      0x00   
#define INTESITY_REG        0x0a
#define BRIGHTNESS          0x00
#define SCAN_LIMIT_REG      0x0b
#define SCAN_ALL_DIGITS     0x07   
#define SHUTDOWN_REG        0x0c
#define NORMAL_OPERATION    0x01
#define DISPLAY_TEST_REG    0x0f
#define DISABLE_TEST        0x00
#define NO_OP_REG           0x00

#include "config/default/peripheral/tmr/plib_tmr2.h"
#include "MAX7219.h"

void wait(uint16_t p)
{
    TMR2_Start() ;
    
    while(TMR2_CounterGet() < p)
        ;
    
    TMR2_Stop() ;
}

void SPI_init(void)
{
    GPIO_CS_OutputEnable() ;
    GPIO_CS_Clear() ;
}
//--------------------------TX: transmit data-----------------------------------
void SPI_write(uint8_t send)
{
    
  for(int Tx = 0 ; Tx < 8 ; Tx++ )
  {
      GPIO_CLK_Clear() ;
      wait(50) ;
    if(send & 0x80) //MSB first.
        GPIO_DIN_Set() ;
    else
        GPIO_DIN_Clear() ;
      wait(50) ;
      GPIO_CLK_Set() ;
      wait(50) ;
      send <<= 1 ;
     
  }
}//--------------------------TX: transmit data-----------------------------------
void SPI_writeRev(uint8_t send)
{ // WRITING OUT THE CHARACTER DATA BACKWARDS, TOO LAZY TO CHANGE ALL THE LETTERS !
    
  for(int Tx = 0 ; Tx < 8 ; Tx++ )
  {
      GPIO_CLK_Clear() ;
      wait(50) ;
    if(send & 0x01) //LSB first.
        GPIO_DIN_Set() ;
    else
        GPIO_DIN_Clear() ;
      wait(50) ;
      GPIO_CLK_Set() ;
      wait(50) ;
      send >>= 1 ;
     
  }
}

void MAX7219_init(char noChips)
{
  SPI_init();
  while(noChips)
        MAX7219_config(--noChips);
}
//------------------------------------------------------------------------------
void MAX7219_config(char chip)
{
  MAX7219_write(DECODE_MODE_REG,DISABLE_DECODE,chip);    
  MAX7219_write(INTESITY_REG,BRIGHTNESS,chip);     
  MAX7219_write(SCAN_LIMIT_REG,SCAN_ALL_DIGITS,chip);     
  MAX7219_write(SHUTDOWN_REG,NORMAL_OPERATION,chip);
  MAX7219_write(DISPLAY_TEST_REG,DISABLE_TEST,chip);   
}
//------------------------------------------------------------------------------
void MAX7219_write(char regName,uint8_t data,char chip)
{
    GPIO_CS_Clear() ;
    
  SPI_write(regName); 
  SPI_write(data); 
  while(chip--)
  {
       MAX7219_NoOperation();        //Used for daisy chained (Cascaded) arrangements
  }
  
  GPIO_CS_Set() ;
 
}//------------------------------------------------------------------------------
void MAX7219_writeRev(char regName,uint8_t data,char chip)
{
    GPIO_CS_Clear() ;
    
  SPI_write(regName); 
  SPI_writeRev(data); 
  while(chip--)
  {
       MAX7219_NoOperation();        //Used for daisy chained (Cascaded) arrangements
  }
  
  GPIO_CS_Set() ;
 
}
//------------------------------------------------------------------------------
void MAX7219_displayText(char* text)
{ 
  char chip = 0;
  uint8_t c ;
 
  while(*text)
  { 
    char row = (*text++) - 'A' ; //32;//(Text-32)...because the first 32 ASCII character codes are none Printable (control chars)
    
    for(int col = 0; col < 8; col++)
    {
        c = (uint8_t)(symbol[(uint8_t)row][(uint8_t)7-col]) ;
        
        MAX7219_writeRev( col+1, c, chip );
    }
    
    chip++;
  }

}

void MAX7219_dropText(char* text)
{ 
  uint8_t drop = 0 ;
  uint8_t c ;
  
  while(drop < 8)
  {
    char *ptr = text ;
    char chip = 0;
    int col ;
    
    while(*ptr)
    { 
     char row = (*ptr++) - 'A' ; //32;//(Text-32)...because the first 32 ASCII character codes are none Printable (control chars)
     
     for(col=0;col<drop;col++)
         MAX7219_writeRev( col+1, 0, chip );
     
        for(col = drop; col < 8; col++)
        {
            c = (uint8_t)(symbol[(uint8_t)row][(uint8_t)7-col+drop]) ;
        
            MAX7219_writeRev( col+1, c, chip );
        }
    
        chip++;
    }
  
    drop++ ;
    wait(500) ;
  }

}



//-----------Passes the data to the adjacent MAX7219 in the Daisy Chain---------
void MAX7219_NoOperation()
{
  SPI_write(NO_OP_REG);           
  SPI_write(0x00);                //Don't care (Can be any arbitrary value)
}
//------------------------------------------------------------------------------
